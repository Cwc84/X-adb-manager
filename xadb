#!/bin/bash

# --- SETTINGS ---
PORT=5555
DB="$HOME/.xadb_devices"

# --- COLORS ---
NC='\033[0m'
GREEN='\033[1;32m'
BLUE='\033[1;34m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
CYAN='\033[1;36m'
BOLD='\033[1m'

# --- INITIALIZATION ---
init() {
    [[ ! -f "$DB" ]] && touch "$DB"
    
    local dependencies=(adb scrcpy awk)
    for tool in "${dependencies[@]}"; do
        if ! command -v "$tool" &> /dev/null; then
            echo -e "${RED}${BOLD}ERROR:${NC} '$tool' is not installed. Please install it first."
            exit 1
        fi
    done
}

# --- UI ELEMENTS ---
banner() {
    clear
    echo -e "${BLUE}${BOLD}"
    cat << "EOF"
  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
  â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
   â•šâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
  â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
  â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• 
EOF
    echo -e "${NC}    ${CYAN}Advanced ADB & Scrcpy Manager${NC}"
    echo -e "    ${YELLOW}Connected Devices: $(adb devices | grep -v "List" | wc -l | xargs)${NC}\n"
}

log_success() { echo -e "${GREEN}[âœ”] $1${NC}"; }
log_error() { echo -e "${RED}[âœ˜] $1${NC}"; }
log_info() { echo -e "${CYAN}[â„¹] $1${NC}"; }

# --- CORE FUNCTIONS ---
get_device_ip() {
    # Reliable IP extraction from Android wlan0 interface
    adb shell ip -f inet addr show wlan0 | awk '/inet / {print $2}' | cut -d/ -f1 | head -n 1
}

validate_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        return 0
    else
        return 1
    fi
}

enable_tcpip() {
    banner
    log_info "Please ensure the device is connected via USB."
    read -p "Proceed? (y/n): " confirm
    [[ "$confirm" != "y" ]] && return

    log_info "Opening TCP/IP port on $PORT..."
    if adb tcpip $PORT; then
        log_success "TCP/IP mode active! You can now unplug the USB cable."
    else
        log_error "Failed to enable TCP/IP. Is the device connected?"
    fi
    read -p "Press Enter to return..."
}

save_device() {
    local id=$1 ip=$2
    # Clean old entry and add new
    grep -v "^$id:" "$DB" > "${DB}.tmp" 2>/dev/null
    echo "$id:$ip" >> "${DB}.tmp"
    mv "${DB}.tmp" "$DB"
    log_success "Device '$id' ($ip) saved to database."
}

add_device_menu() {
    banner
    echo -e "1) ${BOLD}Automatic Detection${NC} (Get IP via USB)"
    echo -e "2) ${BOLD}Manual Entry${NC} (Enter IP manually)"
    echo -e "b) Back"
    read -p "> " opt

    case $opt in
        1)
            local detected_ip=$(get_device_ip)
            if [[ -z "$detected_ip" ]]; then
                log_error "Could not detect IP. Is the device connected via USB?"
            else
                log_success "Detected IP: $detected_ip"
                read -p "Enter Device Alias (e.g., Pixel6): " dev_name
                [[ -n "$dev_name" ]] && save_device "$dev_name" "$detected_ip"
            fi
            ;;
        2)
            read -p "Enter Device Alias: " dev_name
            read -p "Enter IP Address: " dev_ip
            if validate_ip "$dev_ip"; then
                save_device "$dev_name" "$dev_ip"
            else
                log_error "Invalid IP format!"
            fi
            ;;
    esac
    sleep 1
}

connect_and_stream() {
    banner
    if [[ ! -s "$DB" ]]; then
        log_error "No devices found in database."
        sleep 1; return
    fi

    log_info "Saved Devices:"
    awk -F: '{printf "  > %-10s [%s]\n", $1, $2}' "$DB"
    echo
    read -p "Enter Device Alias to connect: " target_id
    
    local target_ip=$(awk -F: -v id="$target_id" '$1==id{print $2}' "$DB")
    
    if [[ -z "$target_ip" ]]; then
        log_error "Alias not found."; sleep 1; return
    fi

    log_info "Connecting to $target_id ($target_ip)..."
    local out=$(timeout 7s adb connect "$target_ip:$PORT" 2>&1)
    
    if [[ $out == *"connected"* ]]; then
        log_success "Connection established. Launching Scrcpy..."
        scrcpy -s "$target_ip:$PORT" --window-title "XADB: $target_id" --always-on-top
    else
        log_error "Connection failed or timed out!"
        echo -e "Debug: $out"
        read -p "Try resetting ADB server? (y/n): " rst
        [[ "$rst" == "y" ]] && { adb kill-server; adb start-server; }
    fi
}

# --- MAIN LOOP ---
main() {
    init
    while true; do
        banner
        echo "1) Enable Wireless Mode (Requires USB)"
        echo "2) Add/Update Device"
        echo "3) Connect & Mirror Screen"
        echo "4) List Saved Devices"
        echo "5) Exit"
        echo
        read -p "Choice: " choice

        case $choice in
            1) enable_tcpip ;;
            2) add_device_menu ;;
            3) connect_and_stream ;;
            4) 
                banner
                log_info "Database Content:"
                awk -F: '{printf " ðŸ“± %-12s : %s\n",$1,$2}' "$DB"
                read -p "Press Enter to return..."
                ;;
            5) exit 0 ;;
            *) log_error "Invalid selection!"; sleep 1 ;;
        esac
    done
}

main
